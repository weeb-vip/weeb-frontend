---
// src/components/PostHog.astro
// PostHog will be loaded client-side with config from window.config
---

<script is:inline>
    // Wait for window.config to be available, then initialize PostHog
    function initPostHog() {
        const config = window.config;

        if (!config || !config.posthog_api_key) {
            console.log("üîç PostHog: No API key found in config, skipping initialization");
            return;
        }

        console.log("üîç Initializing PostHog analytics...");

        // Load PostHog script
        !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys getNextSurveyStep onSessionId".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);

        posthog.init(config.posthog_api_key, {
        api_host: 'https://us.i.posthog.com',
        capture_pageview: true,
        person_profiles: 'identified_only',
        opt_in_site_apps: true // Enable toolbar and other site apps
    });

        // Debug logging for PostHog initialization
        console.log('üîç PostHog initialized with config:', {
            api_host: 'https://us.i.posthog.com',
            capture_pageview: true,
            person_profiles: 'identified_only',
            key: config.posthog_api_key ? 'PROVIDED' : 'MISSING'
        });

        // Override loadToolbar IMMEDIATELY to save state and parameters
        const originalLoadToolbar = window.posthog.loadToolbar;
        window.posthog.loadToolbar = function(params) {
            console.log('üîç PostHog loadToolbar called with params:', params);
            localStorage.setItem('posthog_toolbar_enabled', 'true');
            if (params) {
                console.log('üîç Saving toolbar params for persistence');
                localStorage.setItem('posthog_toolbar_params', JSON.stringify(params));
            }
            return originalLoadToolbar.call(this, params);
        };

        // Add method to disable toolbar
        window.disablePostHogToolbar = () => {
            localStorage.removeItem('posthog_toolbar_enabled');
            localStorage.removeItem('posthog_toolbar_params');
            console.log('üîç PostHog toolbar disabled - refresh to apply');
        };

        console.log('‚úÖ PostHog override installed - you can now run your launch script');

        // Test if PostHog is working and restore toolbar if needed
        setTimeout(() => {
            console.log('üîç PostHog status check:', {
                loaded: !!window.posthog,
                methods: window.posthog ? Object.keys(window.posthog) : 'not available'
            });

            // Check if toolbar was previously loaded
            const toolbarEnabled = localStorage.getItem('posthog_toolbar_enabled');
            const savedParams = localStorage.getItem('posthog_toolbar_params');

            if (toolbarEnabled === 'true') {
                console.log('üîç Restoring PostHog toolbar from previous session');
                if (savedParams) {
                    try {
                        const params = JSON.parse(savedParams);
                        console.log('üîç Restoring with saved params');
                        window.posthog.loadToolbar(params);
                    } catch (e) {
                        console.error('üîç Failed to parse saved toolbar params:', e);
                        window.posthog.loadToolbar();
                    }
                } else {
                    console.log('üîç Restoring without params');
                    window.posthog.loadToolbar();
                }
            }
        }, 1000);
    }

    // Wait for config to be available
    if (window.config) {
        initPostHog();
    } else {
        // Listen for config-loaded event
        document.addEventListener('config-loaded', initPostHog);

        // Fallback: poll for config
        let attempts = 0;
        const checkConfig = setInterval(() => {
            attempts++;
            if (window.config) {
                clearInterval(checkConfig);
                initPostHog();
            } else if (attempts > 50) {
                clearInterval(checkConfig);
                console.warn('üîç PostHog: Config not available after 5 seconds');
            }
        }, 100);
    }

    // Function to reload toolbar
    function reloadToolbar() {
        console.log('üîç reloadToolbar() called');
        const toolbarEnabled = localStorage.getItem('posthog_toolbar_enabled');
        const savedParams = localStorage.getItem('posthog_toolbar_params');

        console.log('üîç Toolbar state:', {
            enabled: toolbarEnabled,
            hasParams: !!savedParams,
            hasPosthog: !!window.posthog
        });

        if (toolbarEnabled === 'true' && window.posthog) {
            console.log('üîç Reloading PostHog toolbar');
            if (savedParams) {
                try {
                    const params = JSON.parse(savedParams);
                    console.log('üîç Reloading with saved params:', params);
                    window.posthog.loadToolbar(params);
                } catch (e) {
                    console.error('üîç Failed to parse saved toolbar params:', e);
                    window.posthog.loadToolbar();
                }
            } else {
                console.log('üîç Reloading without params');
                window.posthog.loadToolbar();
            }
        } else {
            console.log('üîç Not reloading toolbar - conditions not met');
        }
    }

    // Listen to multiple Astro events for view transitions
    document.addEventListener('astro:page-load', () => {
        console.log('üîç EVENT: astro:page-load');
        setTimeout(reloadToolbar, 500);
    });

    document.addEventListener('astro:after-swap', () => {
        console.log('üîç EVENT: astro:after-swap');
        setTimeout(reloadToolbar, 500);
    });

    // Also try popstate for browser back/forward
    window.addEventListener('popstate', () => {
        console.log('üîç EVENT: popstate');
        setTimeout(reloadToolbar, 500);
    });
  </script>
