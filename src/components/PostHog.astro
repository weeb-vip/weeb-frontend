---
// src/components/PostHog.astro
// Only run PostHog on client-side to avoid SSR issues
import { getConfig } from '../config';

let shouldLoadPostHog = false;
let posthogKey = '';

try {
  const config = getConfig();
  if (config && config.posthog_api_key) {
    posthogKey = config.posthog_api_key;
    shouldLoadPostHog = true;
  }
} catch (error) {
  console.warn('PostHog: Failed to load config', error);
}
---

{shouldLoadPostHog &&
  <script is:inline define:vars={{ posthogKey }}>
    console.log("üîç Initializing PostHog analytics...");
    !function(t,e){var o,n,p,r;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,s,a){function g(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(p=t.createElement("script")).type="text/javascript",p.crossOrigin="anonymous",p.async=!0,p.src=s.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(r=t.getElementsByTagName("script")[0]).parentNode.insertBefore(p,r);var u=e;for(void 0!==a?u=e[a]=[]:a="posthog",u.people=u.people||[],u.toString=function(t){var e="posthog";return"posthog"!==a&&(e+="."+a),t||(e+=" (stub)"),e},u.people.toString=function(){return u.toString(1)+".people (stub)"},o="init Ce js Ls Te Fs Ds capture Ye calculateEventProperties zs register register_once register_for_session unregister unregister_for_session Ws getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSurveysLoaded onSessionId getSurveys getActiveMatchingSurveys renderSurvey displaySurvey canRenderSurvey canRenderSurveyAsync identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty Bs Us createPersonProfile Hs Ms Gs opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing get_explicit_consent_status is_capturing clear_opt_in_out_capturing Ns debug L qs getPageViewId captureTraceFeedback captureTraceMetric".split(" "),n=0;n<o.length;n++)g(u,o[n]);e._i.push([i,s,a])},e.__SV=1)}(document,window.posthog||[]);
    posthog.init(posthogKey, {
        api_host: 'https://us.i.posthog.com',
        capture_pageview: true,
        person_profiles: 'identified_only',
        opt_in_site_apps: true // Enable toolbar and other site apps
    });

    // Debug logging for PostHog initialization
    console.log('üîç PostHog initialized with config:', {
        api_host: 'https://us.i.posthog.com',
        capture_pageview: true,
        person_profiles: 'identified_only',
        key: posthogKey ? 'PROVIDED' : 'MISSING'
    });

    // Override loadToolbar IMMEDIATELY to save state and parameters
    const originalLoadToolbar = window.posthog.loadToolbar;
    window.posthog.loadToolbar = function(params) {
        console.log('üîç PostHog loadToolbar called with params:', params);
        localStorage.setItem('posthog_toolbar_enabled', 'true');
        if (params) {
            console.log('üîç Saving toolbar params for persistence');
            localStorage.setItem('posthog_toolbar_params', JSON.stringify(params));
        }
        return originalLoadToolbar.call(this, params);
    };

    // Add method to disable toolbar
    window.disablePostHogToolbar = () => {
        localStorage.removeItem('posthog_toolbar_enabled');
        localStorage.removeItem('posthog_toolbar_params');
        console.log('üîç PostHog toolbar disabled - refresh to apply');
    };

    console.log('‚úÖ PostHog override installed - you can now run your launch script');

    // Test if PostHog is working and restore toolbar if needed
    setTimeout(() => {
        console.log('üîç PostHog status check:', {
            loaded: !!window.posthog,
            methods: window.posthog ? Object.keys(window.posthog) : 'not available'
        });

        // Check if toolbar was previously loaded
        const toolbarEnabled = localStorage.getItem('posthog_toolbar_enabled');
        const savedParams = localStorage.getItem('posthog_toolbar_params');

        if (toolbarEnabled === 'true') {
            console.log('üîç Restoring PostHog toolbar from previous session');
            if (savedParams) {
                try {
                    const params = JSON.parse(savedParams);
                    console.log('üîç Restoring with saved params');
                    window.posthog.loadToolbar(params);
                } catch (e) {
                    console.error('üîç Failed to parse saved toolbar params:', e);
                    window.posthog.loadToolbar();
                }
            } else {
                console.log('üîç Restoring without params');
                window.posthog.loadToolbar();
            }
        }
    }, 1000);

    // Function to reload toolbar
    function reloadToolbar() {
        console.log('üîç reloadToolbar() called');
        const toolbarEnabled = localStorage.getItem('posthog_toolbar_enabled');
        const savedParams = localStorage.getItem('posthog_toolbar_params');

        console.log('üîç Toolbar state:', {
            enabled: toolbarEnabled,
            hasParams: !!savedParams,
            hasPosthog: !!window.posthog
        });

        if (toolbarEnabled === 'true' && window.posthog) {
            console.log('üîç Reloading PostHog toolbar');
            if (savedParams) {
                try {
                    const params = JSON.parse(savedParams);
                    console.log('üîç Reloading with saved params:', params);
                    window.posthog.loadToolbar(params);
                } catch (e) {
                    console.error('üîç Failed to parse saved toolbar params:', e);
                    window.posthog.loadToolbar();
                }
            } else {
                console.log('üîç Reloading without params');
                window.posthog.loadToolbar();
            }
        } else {
            console.log('üîç Not reloading toolbar - conditions not met');
        }
    }

    // Listen to multiple Astro events for view transitions
    document.addEventListener('astro:page-load', () => {
        console.log('üîç EVENT: astro:page-load');
        setTimeout(reloadToolbar, 500);
    });

    document.addEventListener('astro:after-swap', () => {
        console.log('üîç EVENT: astro:after-swap');
        setTimeout(reloadToolbar, 500);
    });

    // Also try popstate for browser back/forward
    window.addEventListener('popstate', () => {
        console.log('üîç EVENT: popstate');
        setTimeout(reloadToolbar, 500);
    });
  </script>
}
